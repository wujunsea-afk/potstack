# PotStack 架构设计文档

## 一、项目概述

PotStack 是一个跨平台的集成后端服务（支持 Windows / Linux），旨在提供零依赖的 Git 托管、应用沙箱运行及自动编排能力。

### 核心特性

- **单进程架构 (AIO)**: 整合路由转发、Git 引擎、沙箱管理和 Loader 编排
- **Pure Go Git 引擎**: 基于 `go-git` 实现，无需安装 Git 客户端
- **Gogs 兼容 API**: 完美对接现有的 Loader 和自动化脚本
- **HTTPS 自动续签**: 支持 Let's Encrypt / ZeroSSL 自动证书管理
- **SQLite 数据库**: 轻量级数据存储
- **Loader 预处理**: 自动初始化系统仓库和部署组件
- **沙箱支持**: 为应用提供隔离运行环境（规划中）

---

## 二、系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PotStack 整体架构                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │     Client      │
                              └────────┬────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                              PotStack Core                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                           Gin Router (HTTP/HTTPS)                        │ │
│  └────────────────────────────────┬────────────────────────────────────────┘ │
│                                   │                                          │
│   ┌───────────────┬───────────────┼───────────────┬───────────────┐         │
│   │               │               │               │               │         │
│   ▼               ▼               ▼               ▼               ▼         │
│ ┌─────────┐ ┌─────────┐   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │
│ │  API    │ │  Git    │   │  Resource   │ │   Loader    │ │   Sandbox   │   │
│ │  Handler│ │  HTTP   │   │   Router    │ │   Module    │ │   Manager   │   │
│ └────┬────┘ └────┬────┘   └──────┬──────┘ └──────┬──────┘ └──────┬──────┘   │
│      │           │               │               │               │          │
│      ▼           ▼               ▼               ▼               ▼          │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                           Service Layer                                 │ │
│ │            (UserService, RepoService, SandboxService)                   │ │
│ └────────────────────────────────┬────────────────────────────────────────┘ │
│                                  │                                          │
│  ┌───────────────────────────────┴────────────────────────────────────────┐ │
│  │                           Data Layer                                   │ │
│  │  ┌─────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│  │  │   SQLite    │  │   File System   │  │     System Repositories     │ │ │
│  │  │   Database  │  │   (Git Repos)   │  │  (keeper/loader/repo.git)   │ │ │
│  │  └─────────────┘  └─────────────────┘  └─────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
                           ┌───────────────────────┐
                           │       Sandbox         │
                           │  (应用隔离运行环境)    │
                           │  ┌─────────────────┐  │
                           │  │   Keeper 守护   │  │
                           │  │   进程管理      │  │
                           │  │   资源隔离      │  │
                           │  └─────────────────┘  │
                           └───────────────────────┘
```

### 2.2 组件说明

| 组件 | 说明 |
|------|------|
| **PotStack Core** | 核心服务进程，提供 API、Git 托管等功能 |
| **Loader Module** | 预处理模块，负责系统初始化和组件部署 |
| **Sandbox Manager** | 沙箱管理器，控制应用的隔离运行（规划中） |
| **Keeper** | 沙箱守护进程，监控和管理沙箱内的应用 |

---

## 三、Loader 模块

### 3.1 职责

Loader 是 PotStack 的预处理模块，负责：

1. **系统初始化**: 创建系统用户和仓库
2. **组件部署**: 解压并推送基础组件到系统仓库
3. **数据库初始化**: 创建 SQLite 数据库和表结构

### 3.2 系统仓库

| 仓库 | 用途 |
|------|------|
| `potstack/keeper.git` | 沙箱守护进程代码 |
| `potstack/loader.git` | Loader 程序代码 |
| `potstack/repo.git` | 核心配置 + SQLite 数据库 |

### 3.3 初始化流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    Loader 初始化流程                             │
└─────────────────────────────────────────────────────────────────┘

  1. 等待 PotStack 服务启动/Data Layer 就绪
         │
         ▼
  2. 创建系统用户 (调用 UserService)
     Username: potstack
         │
         ▼
  3. 创建系统仓库 (调用 RepoService)
     Repos: keeper, loader, repo
         │
         ▼
  4. 解压 potstack-base.zip
         │
         ▼
  5. 推送组件到仓库 (Git Push over HTTP)
     ├── keeper/* → potstack/keeper.git
     ├── loader/* → potstack/loader.git
     └── repo/*   → potstack/repo.git
         │
         ▼
  6. 数据库初始化完成
     potstack/repo.git/data/potstack.db
```

详见 [dev/loader.md](../dev/loader.md)。

---

## 四、沙箱架构（规划中）

### 4.1 概念

沙箱为应用提供隔离的运行环境，包括：

- 进程隔离
- 文件系统隔离
- 网络隔离
- 资源限制

### 4.2 组件

```
┌─────────────────────────────────────────────────────────────────┐
│                       沙箱架构                                   │
└─────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────┐
  │                     PotStack Core                            │
  │  ┌─────────────────────────────────────────────────────────┐ │
  │  │  Sandbox Manager                                         │ │
  │  │  - 创建/销毁沙箱                                          │ │
  │  │  - 沙箱生命周期管理                                       │ │
  │  │  - 资源调度                                               │ │
  │  └──────────────────────────┬──────────────────────────────┘ │
  └─────────────────────────────┼────────────────────────────────┘
                                │
          ┌─────────────────────┼─────────────────────┐
          │                     │                     │
          ▼                     ▼                     ▼
    ┌───────────┐         ┌───────────┐         ┌───────────┐
    │  Sandbox  │         │  Sandbox  │         │  Sandbox  │
    │    #1     │         │    #2     │         │    #N     │
    ├───────────┤         ├───────────┤         ├───────────┤
    │  Keeper   │         │  Keeper   │         │  Keeper   │
    │  ┌─────┐  │         │  ┌─────┐  │         │  ┌─────┐  │
    │  │ App │  │         │  │ App │  │         │  │ App │  │
    │  └─────┘  │         │  └─────┘  │         │  └─────┘  │
    └───────────┘         └───────────┘         └───────────┘
```

### 4.3 Keeper 守护进程

Keeper 运行在每个沙箱内，负责：

| 功能 | 说明 |
|------|------|
| 进程管理 | 启动、停止、监控应用进程 |
| 日志收集 | 收集应用日志并上报 |
| 健康检查 | 定期检查应用健康状态 |
| 资源监控 | 监控 CPU、内存等资源使用 |
| 代码更新 | 从 Git 仓库拉取最新代码 |

### 4.4 沙箱生命周期

```
创建 → 初始化 → 运行 → 停止 → 销毁
  │       │       │      │       │
  ▼       ▼       ▼      ▼       ▼
分配    克隆    启动    停止    清理
资源    代码    Keeper  进程    资源
```

---

## 五、模块设计

### 5.1 目录结构

```
potstack/
├── main.go                      # 入口文件
├── config/
│   └── config.go                # 配置管理
├── internal/
│   ├── api/                     # API 处理器
│   │   ├── user.go              # 用户管理
│   │   ├── repo.go              # 仓库管理
│   │   ├── collaborator.go      # 协作者管理
│   │   └── models.go            # 数据模型
│   ├── auth/
│   │   └── middleware.go        # 认证中间件
│   ├── db/                      # 数据库层
│   │   ├── db.go                # 连接管理
│   │   ├── user.go              # 用户 DAO
│   │   ├── repo.go              # 仓库 DAO
│   │   └── collaborator.go      # 协作者 DAO
│   ├── git/
│   │   └── http_server.go       # Git Smart HTTP
│   ├── https/                   # HTTPS/ACME 管理
│   │   ├── config.go
│   │   ├── manager.go
│   │   ├── acme_client.go
│   │   └── dns_provider.go
│   ├── loader/
│   │   └── loader.go            # Loader 预处理
│   └── router/
│       └── processor.go         # 资源路由
└── docs/                        # 文档
```

### 5.2 模块职责

| 模块 | 职责 |
|------|------|
| **config** | 环境变量读取、路径配置 |
| **api** | HTTP API 处理器 |
| **auth** | Token 认证中间件 |
| **db** | SQLite 数据库操作 |
| **git** | Git Smart HTTP 协议实现（基于 go-git） |
| **https** | TLS 配置、ACME 证书管理 |
| **loader** | 系统初始化、组件部署 |
| **router** | 资源路由处理 |

---

## 六、数据模型

### 6.1 数据库 ER 图

```
┌──────────────┐       ┌────────────────┐       ┌──────────────┐
│     user     │       │   repository   │       │ collaborator │
├──────────────┤       ├────────────────┤       ├──────────────┤
│ id (PK)      │◀──┐   │ id (PK)        │◀──┐   │ id (PK)      │
│ username     │   │   │ owner_id (FK)  │───┘   │ repo_id (FK) │───┐
│ email        │   │   │ name           │       │ user_id (FK) │───┼──┐
│ full_name    │   │   │ full_name      │       │ permission   │   │  │
│ avatar_url   │   │   │ description    │       │ created_at   │   │  │
│ is_admin     │   │   │ is_private     │       └──────────────┘   │  │
│ created_at   │   │   │ uuid           │                          │  │
│ updated_at   │   │   │ created_at     │◀─────────────────────────┘  │
└──────────────┘   │   │ updated_at     │                             │
                   │   └────────────────┘                             │
                   │                                                  │
                   └──────────────────────────────────────────────────┘
```

### 6.2 表结构

详见 [dev/loader.md](../dev/loader.md) 中的数据库设计章节。

---

## 七、数据流

### 7.1 API 请求流程

```
Client Request
      │
      ▼
┌─────────────────┐
│  Gin Router     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Auth Middleware │──── 验证 Token
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  API Handler    │──── HTTP 协议转换 / 参数验证
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Service Layer  │──── 核心业务逻辑 / 事务控制
└────────┬────────┘
         │
         ▼
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│  DB   │ │  FS   │
└───────┘ └───────┘
```

### 7.2 沙箱启动流程（规划）

```
┌─────────────────────────────────────────────────────────────────┐
│                    沙箱启动流程                                  │
└─────────────────────────────────────────────────────────────────┘

  用户请求启动沙箱
         │
         ▼
  ┌─────────────────┐
  │ Sandbox Manager │
  └────────┬────────┘
           │
           ▼
  创建沙箱目录
           │
           ▼
  从仓库克隆代码
  (go-git Clone)
           │
           ▼
  启动 Keeper 守护进程
           │
           ▼
  Keeper 启动应用
           │
           ▼
  注册到 /web/* 路由
           │
           ▼
  沙箱运行中
```

---

## 八、配置管理

### 8.1 环境变量

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `POTSTACK_DATA_DIR` | `data` | 数据根目录 |
| `POTSTACK_HTTP_PORT` | `61080` | 服务端口 |
| `POTSTACK_TOKEN` | 无 | 认证令牌 |

### 8.2 配置文件

| 文件 | 位置 | 说明 |
|------|------|------|
| `https.yaml.example` | 程序同目录 | 配置模板 |
| `https.yaml` | `$DATA_DIR/` | 运行时配置 |

详见 [dev/autocert.md](../dev/autocert.md)。

---

## 九、技术栈

| 技术 | 说明 |
|------|------|
| Go 1.21+ | 开发语言 |
| Gin | Web 框架 |
| go-git | Git 实现 |
| modernc.org/sqlite | 纯 Go SQLite |
| lego | ACME 客户端 |

---

## 十、安全设计

### 10.1 认证

- Token 认证（Header 或 Basic Auth）
- 可配置无 Token 模式（仅用于开发）

### 10.2 路径安全

- 路径遍历防护（`..` 过滤）
- 仓库隔离（用户目录分离）

### 10.3 HTTPS 证书管理

- 支持手动证书配置
- 支持 ACME 自动续签（HTTP-01 / DNS-01）
- **自动续签检查**: 每 12 小时检查证书有效期
- **域名变更检测**: 配置域名改变时自动重申证书
- **证书备份**: 续签前自动备份到 `archive/` 目录
- **管理 API**: 支持查询证书信息和强制续签

**证书存储结构:**
```
data/certs/
├── cert.pem              # 当前证书
├── key.pem               # 当前私钥
├── acme_user.json        # ACME 账户
└── archive/              # 历史存档
    └── YYYYMMDD-HHMMSS/
        ├── cert.pem
        └── key.pem
```

### 10.4 沙箱隔离

- 进程隔离（规划）
- 文件系统隔离（规划）
- 资源限制（规划）

---

## 十一、扩展点

| 扩展点 | 说明 |
|--------|------|
| DNS 提供商 | 可添加新的 DNS-01 提供商 |
| 资源路由 | 可扩展 `/web/*` 和 `/att/*` 处理器 |
| 协作者权限 | 可扩展精细化权限控制 |
| 沙箱类型 | 可支持不同的隔离技术 |
